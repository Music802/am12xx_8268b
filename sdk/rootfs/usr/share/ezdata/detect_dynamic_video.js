/* Dongle AM_JAVASCRIPT_VERSION:0.0.0.2_NEW_2015_03_16_10:58:07; */
function AMTextMatchTools(){}AMTextMatchTools.findMatchForMetaFB=function(htmlContent){return AMTextMatchTools.findMatch(htmlContent,/<meta.*property="og:image".*content="(.*?)".*>/i)};AMTextMatchTools.findMatch=function(text,regexp){var result=null;if(text){var matches=text.match(regexp);result=matches?matches[1]:null}return result};AMTextMatchTools.findValuesForKey=function(params,key){var values=[];if(params&&key){for(var i=0;i<params.length;i++){if(params[i].indexOf(key+"=")===0){values.push(decodeURIComponent(params[i].replace(key+"=","")))}}}return values};AMTextMatchTools.getInnerTextInScriptTag=function(pageContent,attributeName,attributeValue){var expression="<script.*?"+attributeName+"\\s*?=\\s*?"+attributeValue+".*?>([\\s\\S]*?)</script>";var flag=isMultiline?"m":"i";var jsonPattern=new RegExp(expression,flag);var founds=jsonPattern.exec(pageContent);if(founds&&2===founds.length){return founds[1]}return null};AMTextMatchTools.findValueForKey=function(params,key){if(params&&key){for(var i=0;i<params.length;i++){if(params[i].indexOf(key+"=")===0){return decodeURIComponent(params[i].replace(key+"=",""))}}}return null};AMTextMatchTools.getJsonEndWithComma=function(webpage,textBeforeJson,isMultiline){try{var expression=textBeforeJson+"(\\{.*?\\}),$";var flag=isMultiline?"m":"i";var jsonPattern=new RegExp(expression,flag);var found=jsonPattern.exec(webpage);if(null!==found){return JSON.parse(found[1])}}catch(e){AMUtility.debugLog("Parse error: "+e+" for "+found)}return null};AMTextMatchTools.getJsonObjectWithTextBeforeJson=function(htmlContent,textBeforeJson,isMultiline){try{var expression=textBeforeJson+"({.*?}),$";var flag=isMultiline?"m":"i";var jsonPattern=new RegExp(expression,flag);var found=jsonPattern.exec(htmlContent);if(null!==found){return JSON.parse(found[0])}}catch(e){AMUtility.debugLog("Parse error: "+e+" for "+found)}return null};AMTextMatchTools.getJsonObject=function(htmlContent,firstKey){try{var expression='\\{\\s*"'+firstKey+".*\\}";var jsonPattern=new RegExp(expression,"i");var found=jsonPattern.exec(htmlContent);AMUtility.debugLog("found: "+found);if(null!==found){return JSON.parse(found[0])}}catch(e){AMUtility.debugLog("Parse error: "+found)}return null};AMTextMatchTools.findM3U8PlayListInfoMap=function(pageContent,key){var pieces=pageContent.split("\n");var videoQualityMap={};for(var i=0;i<pieces.length;i++){var piece=pieces[i];if("undefined"!==typeof piece&&null!==piece&&piece.indexOf(key+"=")>=0&&"undefined"!==typeof pieces[i+1]&&null!==pieces[i+1]&&pieces[i+1].indexOf("http")==0){var expression="#EXT-X-STREAM-INF:.*PROGRAM-ID=\\d+.*,"+key+"=([^,]+),*";var jsonPattern=new RegExp(expression,"i");var found=jsonPattern.exec(piece);if(found&&found.length>0){AMUtility.debugLog("found: "+found[1]);videoQualityMap[found[1]]=pieces[i+1].trim()}}}return videoQualityMap};AMTextMatchTools.insert=function(originString,index,insertedString){if(index>0)return originString.substring(0,index)+insertedString+originString.substring(index,originString.length);else return insertedString+originString};function AMYoutubeJsPlayerInterpreter(code){this.code=code;this._functions={};this._objects={}}AMYoutubeJsPlayerInterpreter.prototype.interpret_statement=function(self,stmt,local_vars,allow_recursion){if(!allow_recursion){allow_recursion=20}if(allow_recursion<0){throw Error("Recursion limit reached")}AMYoutubeJsPlayerInterpreter.log("[interpret_statement-stmt: "+stmt);if(stmt.indexOf("var ")==0){stmt=stmt.slice("var ".length)}AMYoutubeJsPlayerInterpreter.log("[interpret_statement-stmt: stmt: "+stmt);var expr=null;var assign=null;var founds=stmt.match(/^([a-z]+)(\[([^\]]+)\])?=(.*)$/);var ass_m=null;if(founds&&founds.length>=4){ass_m={};ass_m["out"]=founds[1];ass_m["index"]=founds[3];ass_m["expr"]=expr=founds[4];AMYoutubeJsPlayerInterpreter.log("ass_m:");AMYoutubeJsPlayerInterpreter.log(ass_m)}if(ass_m){if(ass_m["index"]){AMYoutubeJsPlayerInterpreter.log("ass_m[index]: "+ass_m["index"]);assign=function(val){var lvar=local_vars[ass_m["out"]];var idx=self.interpret_expression(self,ass_m["index"],local_vars,allow_recursion);if(!isNaN(idx)){AMYoutubeJsPlayerInterpreter.log("assign value "+val+" to lvar "+lvar+" at idx "+idx);lvar[idx]=val;return val}else{throw TypeError("idx: "+idx+" is not a number")}};expr=ass_m["expr"]}else{AMYoutubeJsPlayerInterpreter.log("no index");assign=function(val){local_vars[ass_m["out"]]=val;AMYoutubeJsPlayerInterpreter.log("param: "+ass_m["out"]+" val: "+val);AMYoutubeJsPlayerInterpreter.log(val);if(val){AMYoutubeJsPlayerInterpreter.log("val len: "+val.length)}return val};expr=ass_m["expr"]}}else if(stmt.indexOf("return")==0){AMYoutubeJsPlayerInterpreter.log("return");assign=function(v){return v};expr=stmt.slice("return ".length)}else{AMYoutubeJsPlayerInterpreter.log("else");expr=stmt;assign=function(v){return v}}AMYoutubeJsPlayerInterpreter.log("expr: "+expr);AMYoutubeJsPlayerInterpreter.log("local_vars:");AMYoutubeJsPlayerInterpreter.log(local_vars);var v=self.interpret_expression(self,expr,local_vars,allow_recursion);AMYoutubeJsPlayerInterpreter.log("assign: "+assign);AMYoutubeJsPlayerInterpreter.log("v: "+v);var resp=assign(v);AMYoutubeJsPlayerInterpreter.log("resp: "+resp);return resp};AMYoutubeJsPlayerInterpreter.prototype.interpret_expression=function(self,expr,local_vars,allow_recursion){AMYoutubeJsPlayerInterpreter.log("interpret_expression: "+expr+" local_vars: "+local_vars);for(var i in local_vars){AMYoutubeJsPlayerInterpreter.log("loca_vars["+i+"]: "+local_vars[i])}if(!isNaN(expr)){AMYoutubeJsPlayerInterpreter.log("is number");return new Number(expr)}if(this.isAlpha(expr)){AMYoutubeJsPlayerInterpreter.log("is alpha");return local_vars[expr]}try{return eval(expr)}catch(err){AMYoutubeJsPlayerInterpreter.log("eval failed for expression: "+expr+" with err: "+err)}var founds=expr.match(/^([a-zA-Z0-9_$]+)\.([^(]+)(\(+([^()]*)\))?$/);if(founds&&founds.length>4){AMYoutubeJsPlayerInterpreter.log("founds execution: "+founds);var variable=founds[1];var member=founds[2];var arg_str=founds[4];AMYoutubeJsPlayerInterpreter.log("variable: "+variable+" ,member: "+member+" ,arg_str: "+arg_str);var obj=null;if(local_vars[variable]){obj=local_vars[variable];AMYoutubeJsPlayerInterpreter.log("get from local_var: "+obj)}else{AMYoutubeJsPlayerInterpreter.log("not in local_vars");if(!self._objects[variable]){AMYoutubeJsPlayerInterpreter.log("try extract_object for variable: "+variable);self._objects[variable]=self.extract_object(self,variable)}obj=self._objects[variable];AMYoutubeJsPlayerInterpreter.log("get from _objects for variable: "+variable);AMYoutubeJsPlayerInterpreter.log(obj)}if(!this.endsWith(expr,")")){AMYoutubeJsPlayerInterpreter.log("no arg_str, member access. resp: "+obj[member]);return obj[member]}if(this.endsWith(expr,")")){AMYoutubeJsPlayerInterpreter.log("yes end with ) for expr: "+expr);var argvals=[];AMYoutubeJsPlayerInterpreter.log("pre list: |"+arg_str+"| len: "+arg_str.length);if(arg_str&&arg_str!==""){AMYoutubeJsPlayerInterpreter.log("try get param list. original list: "+arg_str);var preArgVals=arg_str.split(",").map(function(v){return v.trim()});for(var i in preArgVals){var rawVal=preArgVals[i];AMYoutubeJsPlayerInterpreter.log("try trans rawVal:"+rawVal+" local_vars:");AMYoutubeJsPlayerInterpreter.log(local_vars);var val=self.interpret_expression(self,rawVal,local_vars,allow_recursion);AMYoutubeJsPlayerInterpreter.log("translated rawVal: "+rawVal+" to "+val+" val.len: "+val.length);argvals.push(val)}}AMYoutubeJsPlayerInterpreter.log("apply obj for member: "+member+" on obj: "+obj+" with argvals: "+argvals+" argvals.len: "+argvals.length);AMYoutubeJsPlayerInterpreter.log(obj);AMYoutubeJsPlayerInterpreter.log("func: "+obj[member]);var resp=obj[member].apply(obj,argvals);AMYoutubeJsPlayerInterpreter.log("resp: "+resp);return resp}}founds=expr.match(/^([a-z]+)\[(.+)\]$/);if(founds&&founds.length>2){var val=founds[1];val=local_vars[val];var idx=founds[2];idx=self.interpret_expression(self,idx,local_vars,allow_recursion-1);AMYoutubeJsPlayerInterpreter.log("idx: "+idx);AMYoutubeJsPlayerInterpreter.log("val[idx]: "+val[idx]);return val[idx]}founds=expr.match(/^(.+?)([%])(.+?)$/);if(founds&&founds.length>=4){var a=self.interpret_expression(self,founds[1],local_vars,allow_recursion);var b=self.interpret_expression(self,founds[3],local_vars,allow_recursion);return a%b}founds=expr.match(/^([a-zA-Z$]+)\(([a-z0-9,]+)\)$/);if(founds&&founds.length>=2){var fname=founds[1];var argvals=founds[2];if(argvals){argvals=arg_str.split(",").map(function(v){return v.trim()})}if(!self._functions[fname]){self._functions[fname]=self.extract_function(self,fname);return self._functions[fname].apply(self,argvals)}}throw Error("Unsupported JS expression "+expr)};AMYoutubeJsPlayerInterpreter.prototype.endsWith=function(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1};AMYoutubeJsPlayerInterpreter.prototype.isAlpha=function(text){if(text.search(/[^A-Za-z\s]/)!=-1){return false}return true};AMYoutubeJsPlayerInterpreter.prototype.extract_object=function(self,objname){AMYoutubeJsPlayerInterpreter.log("extract_object for "+objname);var obj={};var fields=null;var fields_m=null;var expression="(var\\s+)?"+this.escape(objname)+"\\s*=\\s*\\{\\s*(([a-zA-Z$0-9]+\\s*:\\s*function\\(.*?\\)\\s*\\{.*?\\})*)\\}\\s*;";var pattern=new RegExp(expression,"i");var founds=pattern.exec(self.code);if(founds&&founds.length>2){AMYoutubeJsPlayerInterpreter.log("extract_object found:  "+founds);fields=founds[2];AMYoutubeJsPlayerInterpreter.log(fields)}else{AMYoutubeJsPlayerInterpreter.log("found null")}if(fields){var matches=[];var expression="([a-zA-Z$0-9]+)\\s*:\\s*function\\(([a-z,]+)\\)\\{([^}]+)\\}";var pattern=new RegExp(expression,"g");var match=null;while((match=pattern.exec(fields))!==null){var subObj={};var key=match[1];var args=match[2];var argnames=args.split(",").map(function(v){return v.trim()});var code=match[3];AMYoutubeJsPlayerInterpreter.log("key: "+key+" argnames: "+argnames+" code: "+code);obj[key]=self.build_function(self,argnames,code);AMYoutubeJsPlayerInterpreter.log("------ ------ ------");AMYoutubeJsPlayerInterpreter.log(obj[key]);AMYoutubeJsPlayerInterpreter.log("------ ------ ------")}return obj}return obj};AMYoutubeJsPlayerInterpreter.prototype.escape=function(text){return text.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")};AMYoutubeJsPlayerInterpreter.prototype.extract_function=function(self,funcname){try{var expression="(function "+this.escape(funcname)+"|[\\{;]"+this.escape(funcname)+"\\s*=\\s*function)\\(([a-z,]+)\\)\\{([^}]+)\\}";var jsonPattern=new RegExp(expression);var func_code=null;var func_args=null;var founds=jsonPattern.exec(this.code);AMYoutubeJsPlayerInterpreter.log("this.code.length: "+this.code.length+", founds: "+founds);if(founds&&founds.length>3){func_code=founds[3];func_args=founds[2];var argnames=func_args.split(",").map(function(v){return v.trim()});AMUtility.debugLog("func code: "+func_code);AMUtility.debugLog("func args: "+argnames);if(func_code){return self.build_function(self,argnames,func_code)}}}catch(e){AMUtility.debugLog("Parse error: "+e+" for "+founds[0])}return null};AMYoutubeJsPlayerInterpreter.prototype.build_function=function(self,argnames,code){function resf(){AMYoutubeJsPlayerInterpreter.log("build_function- argnames: "+argnames+" argnames.len: "+argnames.length+" arguments: "+arguments+" arguments.len: "+arguments.length+" code: "+code);var local_vars=self.dict_zip(argnames,arguments);var segments=code.split(";");var res=null;for(var i=0;i<segments.length;i++){var stmt=segments[i];res=self.interpret_statement(self,stmt,local_vars)}return res}return resf};AMYoutubeJsPlayerInterpreter.prototype.dict_zip=function(key_array,val_array){AMYoutubeJsPlayerInterpreter.log("key_array: "+key_array+" len: "+key_array.length);AMYoutubeJsPlayerInterpreter.log("val_array: "+val_array+" len: "+val_array.length);if(key_array.length>0&&val_array.length>0){var obj={};var len=key_array.length;for(var i=0;i<len;i++){var key=key_array[i];var value=val_array[i];obj[key]=value;AMYoutubeJsPlayerInterpreter.log("key: "+key);AMYoutubeJsPlayerInterpreter.log("value: "+value+" len: "+value.length)}return obj}else{AMUtility.debugLog("parameters invalid")}AMYoutubeJsPlayerInterpreter.log("return null");return null};AMYoutubeJsPlayerInterpreter.isLog=false;AMYoutubeJsPlayerInterpreter.log=function(msg){if(true==AMYoutubeJsPlayerInterpreter.isLog){AMUtility.debugLog(msg)}};function DailyMotionProbe(url){AMUtility.debugLog("Init DailyMotionProbe");var videoId=this.getVideoId(url);AMUtility.debugLog("find vid: "+videoId+" for url: "+url);this.webPage=this._getInfoPage(videoId);AMUtility.debugLog("web page length: "+this.webPage.length)}DailyMotionProbe.prototype.getName=function(){return"DailyMotionProbe"};DailyMotionProbe.can=function(url){return undefined!==url&&null!==url&&url.indexOf("dailymotion.com")>=0};DailyMotionProbe.prototype.getMedias=function(){var videos=[];if(this.webPage){var jsonObj=AMTextMatchTools.getJsonEndWithComma(this.webPage,"var info = ",true);videos=this.getHQDailyMotionVideos(jsonObj)}return videos};DailyMotionProbe.prototype.getHQDailyMotionVideos=function(jsonObj){var videos=new Array;if(jsonObj&&jsonObj["stream_h264_hd1080_url"]){AMUtility.debugLog("find 1080P: "+jsonObj["stream_h264_hd1080_url"]);videos.push(jsonObj["stream_h264_hd1080_url"])}if(jsonObj&&jsonObj["stream_h264_hd_url"]){AMUtility.debugLog("find hd: "+jsonObj["stream_h264_hd_url"]);videos.push(jsonObj["stream_h264_hd_url"])}if(jsonObj&&jsonObj["stream_h264_hq_url"]){AMUtility.debugLog("find hq: "+jsonObj["stream_h264_hq_url"]);videos.push(jsonObj["stream_h264_hq_url"])}if(jsonObj&&jsonObj["stream_h264_url"]){AMUtility.debugLog("find standard: "+jsonObj["stream_h264_url"]);videos.push(jsonObj["stream_h264_url"])}return videos};DailyMotionProbe.prototype.getMediaSource=function(){var videos=[];if(this.webPage){var medias=this.getMedias();if(medias&&medias.length>0){videos.push(medias[0])}}return videos};DailyMotionProbe.prototype.getVideoId=function(url){var matches=url.match(/(?:https?:\/\/)?(?:(?:www|touch)\.)?dailymotion\.[a-z]{2,3}\/(?:(?:embed|#)\/)?video\/([^\/?_]+)/i);return null!==matches&&matches.length>0?matches[matches.length-1]:null};DailyMotionProbe.prototype._getInfoPage=function(videoId){if(videoId){var video_info_url="http://www.dailymotion.com/embed/video/"+videoId;return AMUtility.httpGet(video_info_url,30)}return null};DailyMotionProbe.prototype.getVideoImage=function(){var image=null;if(this.webPage){var jsonObj=AMTextMatchTools.getJsonEndWithComma(this.webPage,"var info = ",true);image=jsonObj&&jsonObj["thumbnail_url"]?jsonObj["thumbnail_url"]:null}return image};DailyMotionProbe.prototype.getVideoTitle=function(){var title=null;if(this.webPage){var jsonObj=AMTextMatchTools.getJsonEndWithComma(this.webPage,"var info = ",true);title=jsonObj&&jsonObj["title"]?jsonObj["title"]:null}return title};function TwitchProbe(url){AMUtility.debugLog("Init TwitchProbe");this.videoUrl=url;AMUtility.debugLog("find vid: "+this.videoId+" for url: "+url)}TwitchProbe.prototype.getName=function(){return"TwitchProbe"};TwitchProbe.can=function(url){return undefined!==url&&null!==url&&url.indexOf("twitch.tv")>=0};TwitchProbe.prototype.parseUrl=function(url){var groups={};var matches=url.match(/https?:\/\/www\.twitch\.tv\/([a-zA-Z0-9_]+)(?:\/mobile|\/?([b|v|c])\/([0-9]+))?/i);if(matches&&matches.length>1){groups.id=matches[1];groups.category=matches[2];groups.cid=matches[3];AMUtility.debugLog("id: "+groups.id+", category: "+groups.category+", cid: "+groups.cid)}return groups};TwitchProbe.prototype.getByCategoryVideoId=function(groups){var videos=[];var page_url="https://api.twitch.tv/api/videos/a"+groups.cid;var page_content=AMUtility.httpGet(page_url);AMUtility.debugLog("get page_content: \n"+page_content);var jscode="this.info="+page_content;AMUtility.debugLog("jscode: \n"+jscode);eval(jscode);if(this.info&&this.info.chunks&&this.info.chunks.live&&this.info.chunks.live.length>0){for(var i=0;i<this.info.chunks.live.length;i++){var video_url=this.info.chunks.live[i]&&this.info.chunks.live[i].url?this.info.chunks.live[i].url:null;if(video_url){AMUtility.debugLog("push video: "+video_url);videos.push(video_url)}}this.info=null}return videos};TwitchProbe.prototype.getByCategoryVodId=function(groups){var videos=[];var auth_url="https://api.twitch.tv/api/vods/"+groups.cid+"/access_token";var auth_content=AMUtility.httpGet(auth_url);eval("this.info="+auth_content);if(this.info){var token=this.info.token;var sig=this.info.sig;if(groups&&groups.cid&&token&&sig){var video_url="http://usher.twitch.tv/vod/"+groups.cid+"?nauth="+token+"&nauthsig="+sig;AMUtility.debugLog("push video: "+video_url);videos.push(video_url)}}this.info=null;return videos};TwitchProbe.prototype.getByCategoryChapterId=function(groups){var videos=[];var page_url="https://api.twitch.tv/api/videos/c"+groups.cid;var page_content=AMUtility.httpGet(page_url);eval("this.info="+page_content);if(this.info&&this.info.chunks&&this.info.chunks.live){for(var i=0;i<this.info.chunks.live.length;i++){var video_url=this.info.chunks.live[i]&&this.info.chunks.live[i].url?this.info.chunks.live[i].url:null;if(video_url){AMUtility.debugLog("push video: "+video_url);videos.push(video_url)}}}this.info=null;return videos};TwitchProbe.prototype.getByCategoryLive=function(groups){var videos=[];var online_url="https://api.twitch.tv/kraken/streams/"+groups.id;var online_content=AMUtility.httpGet(online_url);if(online_content.indexOf('"stream":null')<0){AMUtility.debugLog(groups.id+" is online");var auth_url="http://api.twitch.tv/api/channels/"+groups.id+"/access_token?on_site=1";var auth_content=AMUtility.httpGet(auth_url);var token=null;var sig=null;var matches=auth_content.match(/\"token\":\"(\{.+\})\",(?:\"sig\":\")([a-zA-Z0-9]+)\",/i);if(matches&&matches.length>2){token=matches[1].replace(/\\\"/g,'"');sig=matches[2];AMUtility.debugLog("token: "+token);AMUtility.debugLog("sig: "+sig)}if(groups.id&&token&&sig){var video_url="http://usher.twitch.tv/api/channel/hls/"+groups.id+".m3u8?token="+token+"&sig="+sig;AMUtility.debugLog("push video: "+video_url);videos.push(video_url)}}else{AMUtility.debugLog(groups.id+" is offline")}return videos};TwitchProbe.prototype.getMedias=function(){var videos=[];var groups=this.parseUrl(this.videoUrl);AMUtility.debugLog("category = "+groups.category);switch(groups.category){case"b":videos=this.getByCategoryVideoId(groups);break;case"v":videos=this.getByCategoryVodId(groups);break;case"c":videos=this.getByCategoryChapterId(groups);break;default:videos=this.getByCategoryLive(groups)}return videos};TwitchProbe.prototype.getMediaSource=function(){var videos=this.getMedias();AMUtility.debugLog("found video length: "+videos.length);return videos};function VimeoProbe(url){AMUtility.debugLog("Init VimeoProbe url: "+url);this.url=url;this.vimeoObject=null}VimeoProbe.createProbeByVid=function(vid){var probe=new VimeoProbe;probe.extractVimeoObject(vid);return probe};VimeoProbe.prototype.getName=function(){return"VimeoProbe"};VimeoProbe.can=function(url){return url&&url.indexOf("vimeo.com")>=0?true:false};VimeoProbe.prototype.getVimeoObjectByConfigUrl=function(vid){AMUtility.debugLog("By Config Url for ["+vid+"]");var vimeoObject=null;if(vid){var url="https://vimeo.com/"+vid;var web_page=AMUtility.httpGet(url);AMUtility.debugLog("web_page length: "+web_page.length);if(web_page){var founds=web_page.match(/ data-config-url="(.+?)"/);if(founds&&founds.length>1){config_url=founds[1].replace(/&amp;/g,"&");var config_page=AMUtility.httpGet(config_url);AMUtility.debugLog("config_page length: "+config_page.length+" url: "+config_url);vimeoObject=AMTextMatchTools.getJsonObject(config_page,"cdn_url")}}}return vimeoObject};VimeoProbe.prototype.getVimeoObjectByPlayerUrl=function(vid){AMUtility.debugLog("By Player Url for ["+vid+"]");var vimeoObject=null;var infoUrl="http://player.vimeo.com/video/"+vid;var web_page=AMUtility.httpGet(infoUrl);AMUtility.debugLog("web_page length: "+web_page.length);if(web_page){vimeoObject=AMTextMatchTools.getJsonObject(web_page,"cdn_url")}return vimeoObject};VimeoProbe.prototype.extractVimeoObject=function(vid){if(vid){this.vimeoObject=this.getVimeoObjectByPlayerUrl(vid);if(!this.vimeoObject){this.vimeoObject=this.getVimeoObjectByConfigUrl(vid)}if(!this.vimeoObject){AMUtility.debugLog("Cannot find vimeo object for ["+vid+"]")}}else{AMUtility.debugLog("Cannot find video id for url: "+url)}return this.vimeoObject};VimeoProbe.prototype.getVideoImage=function(){var image=null;if(this.vimeoObject){var videoObject=this.vimeoObject["video"];if(videoObject){var thumbs=videoObject["thumbs"];if(thumbs){AMUtility.debugLog("found thumbnail in jsonData: "+thumbs["base"]);image="undefined"!==typeof thumbs["base"]?thumbs["base"]:null}}}else{AMUtility.debugLog("Cannot retrieve information. Please extract vimeo object before using this method.")}return image};VimeoProbe.prototype.getVideoTitle=function(){var title=null;if(this.vimeoObject){var videoObject=this.vimeoObject?this.vimeoObject["video"]:null;if(videoObject){title="undefined"!==typeof videoObject["title"]?videoObject["title"]:null}}else{AMUtility.debugLog("Cannot retrieve information. Please extract vimeo object before using this method.")}return title};VimeoProbe.prototype.getMobileMedias=function(){var videos=[];if(this.vimeoObject){try{var mediaInfo=this.vimeoObject["request"]["files"]["h264"];if(mediaInfo&&"undefined"!==typeof mediaInfo["mobile"]&&null!==mediaInfo["mobile"]&&"undefined"!==typeof mediaInfo["mobile"]["url"]&&null!==mediaInfo["mobile"]["url"]){AMUtility.debugLog("found mobile: "+mediaInfo["mobile"]["url"]);videos.push(mediaInfo["mobile"]["url"])}}catch(err){AMUtility.debugLog(err)}}else{AMUtility.debugLog("Cannot retrieve information. Please extract vimeo object before using this method.")}return videos};VimeoProbe.prototype.getMedias=function(){var videos=[];if(this.vimeoObject){try{var mediaInfo=this.vimeoObject["request"]["files"]["h264"];if(mediaInfo&&"undefined"!==typeof mediaInfo["hd"]&&null!==mediaInfo["hd"]&&"undefined"!==typeof mediaInfo["hd"]["url"]&&null!==mediaInfo["hd"]["url"]){AMUtility.debugLog("found hd: "+mediaInfo["hd"]["url"]);videos.push(mediaInfo["hd"]["url"])}if(mediaInfo&&"undefined"!==typeof mediaInfo["sd"]&&null!==mediaInfo["sd"]&&"undefined"!==typeof mediaInfo["sd"]["url"]&&null!==mediaInfo["sd"]["url"]){AMUtility.debugLog("found sd: "+mediaInfo["sd"]["url"]);videos.push(mediaInfo["sd"]["url"])}}catch(err){AMUtility.debugLog("Fail to find hq video with error: "+err)}}else{AMUtility.debugLog("Cannot retrieve information. Please extract vimeo object before using this method.")}return videos};VimeoProbe.prototype.getVimeoVideoId=function(){var videoId=null;var matches=this.url?this.url.match(/https?:\/\/(player\.)?vimeo\.com\/([^0-9]*)([0-9]+)/):null;AMUtility.debugLog("matches: "+matches);if(matches&&matches.length>3){videoId=matches[matches.length-1]}return videoId};VimeoProbe.prototype.getMediaSource=function(){var videos=[];var videoId=this.getVimeoVideoId();AMUtility.debugLog("videoId: "+videoId);if(videoId){this.extractVimeoObject(videoId);if(this.vimeoObject){var medias=this.getMedias();if(medias&&medias.length>0){videos.push(medias[0])}}else{AMUtility.debugLog("Failed to find Vimeo Object")}}else{AMUtility.debugLog("Cannot find video id for url: "+this.url)}return videos&&videos.length>0?videos:null};var AM_GLOBAL_OBJECT=this;function YoutubeProbe(url,decodeMode){AMUtility.debugLog("init YoutubeProbe with decode mode: "+decodeMode+" for url: "+url);this.url=url;if(decodeMode){this.decodeMode=decodeMode}else{this.decodeMode=YoutubeProbe.INJECTION_DECODE}}YoutubeProbe.LEGACY_DECODE=1;YoutubeProbe.INJECTION_DECODE=2;YoutubeProbe.INTERPRETER_DECODE=3;YoutubeProbe.prototype.getName=function(){return"YoutubeProbe"};YoutubeProbe.can=function(url){return url&&url.indexOf("youtube.com")>=0||url.indexOf("youtu.be")>=0?true:false};YoutubeProbe.prototype.getMediaSourcesFromVid=function(vid,tags){var videos=[];if(vid){var video_info_url="https://www.youtube.com/watch?v="+vid+"&gl=US&hl=en&has_verified=1&app=desktop";var video_info_page=AMUtility.httpGet(video_info_url);if(video_info_page){AMUtility.debugLog("video_info_page.len: "+video_info_page.length);var yptPlayer_config=AMTextMatchTools.findMatch(video_info_page,/;ytplayer\.config\s*=\s*(\{.*?\}+);/);if(yptPlayer_config){AMUtility.debugLog("yptPlayer_config: "+yptPlayer_config.length)}var totalMap=this.getAdaptiveFmtsMap(yptPlayer_config);var url_encoded_fmt_stream_map=this.getUrlEcondedFmtStreamMap(yptPlayer_config);if(url_encoded_fmt_stream_map&&totalMap){totalMap+=","+url_encoded_fmt_stream_map}else if(url_encoded_fmt_stream_map&&!totalMap){totalMap=url_encoded_fmt_stream_map}if(totalMap){var decodeFunc=null;switch(this.decodeMode){case YoutubeProbe.LEGACY_DECODE:AMUtility.debugLog("use LOCAL_DECODE");decodeFunc=this.getLocalDecodeFunc();break;case YoutubeProbe.INTERPRETER_DECODE:AMUtility.debugLog("use INTERPRETER_DECODE");var playerUrl=this.getPlayerUrl(video_info_page);decodeFunc=this.getDecodeFuncByInterpreter(playerUrl);break;default:AMUtility.debugLog("use INJECTION_DECODE");var playerUrl=this.getPlayerUrl(video_info_page);decodeFunc=this.getDecodeFunc(playerUrl);break}if(tags&&tags.length>0){videos=this.getMediasFromYoutubeMap(totalMap,decodeFunc,tags);AMUtility.debugLog("from set tags: "+videos+" tags: "+tags)}else{videos=this.getMediasFromYoutubeMap(totalMap,decodeFunc,["37","22","18"])}}else{videos=[];var hlsvp=this.getHLSVP(yptPlayer_config);if(hlsvp){AMUtility.debugLog("[hlsvp]: "+hlsvp);videos.push(hlsvp)}else{AMUtility.debugLog("video source cannot be resolved")}}}else{AMUtility.debugLog("Cannot get page content for url: "+video_info_url)}}else{AMUtility.debugLog("No video id provided!")}AMUtility.debugLog("[YoutubeProbe]");return videos};YoutubeProbe.prototype.getMediaSourcesFromUrl=function(url,tags){var vid=this.getVideoId(url);AMUtility.debugLog("Find vid: ["+vid+"]");return this.getMediaSourcesFromVid(vid,tags)};YoutubeProbe.prototype.getMediaSource=function(tags){var videos=[];var medias=this.getMediaSourcesFromUrl(this.url,tags);AMUtility.debugLog("getMediaSource medias length: "+medias.length);if(medias&&medias.length>0){videos.push(medias[0])}return videos};YoutubeProbe.prototype.findStreamWithITag=function(streams,itag){for(var i=0;i<streams.length;i++){if(streams[i].indexOf("itag="+itag)>=0){return streams[i]}}return null};YoutubeProbe.prototype.getVideoUrlFromStream=function(stream,decodeFunc){if(stream){var params=stream.split("&");var signature=AMTextMatchTools.findValueForKey(params,"sig");AMUtility.debugLog("sig:"+signature);if(signature===null){var encodedSig=AMTextMatchTools.findValueForKey(params,"s");if(encodedSig!==null){AMUtility.debugLog("encodedSig:"+encodedSig);AMUtility.debugLog("encodedSig length:"+encodedSig.split(".")[0].length+"."+encodedSig.split(".")[1].length);if(decodeFunc){signature=decodeFunc(encodedSig);AMUtility.debugLog("decodedSig:"+signature);AMUtility.debugLog("decodedSig length:"+signature.split(".")[0].length+"."+signature.split(".")[1].length)}else{AMUtility.debugLog("No decode function found")}}}var streamUrl=AMTextMatchTools.findValueForKey(params,"url");if(signature!==null){AMUtility.debugLog("add signature to video src");return streamUrl+"&signature="+signature}else{if(streamUrl.indexOf("signature=")>=0){AMUtility.debugLog("signautre already in url");return streamUrl}}}return null};YoutubeProbe.prototype.getMediasFromYoutubeMap=function(map,decodeFunc,keys){var videos=new Array;if(map&&keys){var streams=map.split(",");for(var i=0;i<keys.length;i++){var stream=this.findStreamWithITag(streams,keys[i]);AMUtility.debugLog("original stream: "+stream);var aVideoUrl=this.getVideoUrlFromStream(stream,decodeFunc);if(aVideoUrl){AMUtility.debugLog("push keys[i]: "+keys[i]+" src: "+aVideoUrl);videos.push(aVideoUrl)}else{AMUtility.debugLog("No videoUrl for keys["+keys[i]+"], videoUrl: "+aVideoUrl)}}}AMUtility.debugLog("getMediasFromYoutubeMap: "+videos.length+" typeof "+typeof videos);return videos};YoutubeProbe.prototype.getHLSVP=function(yptPlayer_config){var hlsvp=AMTextMatchTools.findMatch(yptPlayer_config,/"hlsvp"\s*:\s*"(.*?)"/);if(hlsvp){hlsvp=decodeURIComponent(hlsvp).replace(/\\\//g,"/")}return hlsvp};YoutubeProbe.prototype.getUrlEcondedFmtStreamMap=function(yptPlayer_config){var map=null;var url_encoded_fmt_stream_map=AMTextMatchTools.findMatch(yptPlayer_config,/"url_encoded_fmt_stream_map"\s*:\s*"(.*?)"/);if(url_encoded_fmt_stream_map){var urlEncodedFmtStreamJsonMap=null;try{urlEncodedFmtStreamJsonMap=JSON.parse('"'+url_encoded_fmt_stream_map+'"');map=urlEncodedFmtStreamJsonMap}catch(err){AMUtility.debugLog("failed to convert url_encoded_fmt_stream_map to json object")}}return map};YoutubeProbe.prototype.getAdaptiveFmtsMap=function(yptPlayer_config){var map=null;if(yptPlayer_config){var adaptive_fmts_map=AMTextMatchTools.findMatch(yptPlayer_config,/"adaptive_fmts"\s*:\s*"(.*?)"/);if(adaptive_fmts_map){var adaptiveFmtsJsonMap=null;try{adaptiveFmtsJsonMap=JSON.parse('"'+adaptive_fmts_map+'"')}catch(err){AMUtility.debugLog("failed to covert adaptive_fmts to json object")}if(adaptiveFmtsJsonMap){map=adaptiveFmtsJsonMap;AMUtility.debugLog("map: "+map.length)}}}return map};YoutubeProbe.prototype.getVideoId=function(url){var video_id=null;var founds=url.match(/https?:\/\/(www|m)\.youtube\.com\/.*(watch\?v=|v\/|embed\/)([^#&?]+)/);if(founds&&founds.length>3){video_id=founds[3]}else{founds=url.match(/https?:\/\/youtu.be\/([^#&?]+)/);if(founds&&founds.length>1){video_id=founds[1]}}if(!video_id){AMUtility.debugLog("failed to extract video id for src: "+url)}else{AMUtility.debugLog("found video_id: "+video_id)}return video_id};YoutubeProbe.prototype.extractDecodeFunction=function(jscode,funcname){try{var expression="(function "+funcname+"|[\\{;]"+funcname+"\\s*=\\s*function)\\([a-z,]+\\)\\{[^}]+\\};?";AMUtility.debugLog(expression);var jsonPattern=new RegExp(expression,"i");var founds=jsonPattern.exec(jscode);if(founds.length>0){AMUtility.debugLog("founds: "+founds[0]);return founds[0]}}catch(e){AMUtility.debugLog("Parse error: "+e+" for "+founds[0])}return null};YoutubeProbe.prototype.getPlayerUrl=function(video_info_page){var playerUrl=null;var expression='"assets"\\s*:.*?"js"\\s*:\\s*("[^"]+")';var pattern=new RegExp(expression,"i");var founds=pattern.exec(video_info_page);if(founds&&founds.length>1){playerUrl="https:"+eval(founds[1])}AMUtility.debugLog("player url: "+playerUrl);return playerUrl};YoutubeProbe.prototype.getLocalDecodeFunc=function(){AMUtility.debugLog("getLocalDecodeFunc");var functionName=AMTextMatchTools.findMatch(document.body.innerHTML,/signature=([a-zA-Z]+)\(+/);if(null!==functionName){AMUtility.debugLog("functionName:"+functionName);if(AM_GLOBAL_OBJECT[functionName]){return AM_GLOBAL_OBJECT[functionName]}}return null};YoutubeProbe.prototype.getDecodeFuncByInterpreter=function(playerUrl){AMUtility.debugLog("getDecodeFunc for player: "+playerUrl);if(playerUrl){var jsplayer=AMUtility.httpGet(playerUrl);AMUtility.debugLog("jsplayer got. len: "+jsplayer.length);var functionName=AMTextMatchTools.findMatch(jsplayer,/signature=([a-zA-Z]+)\(+/);if(!functionName){AMUtility.debugLog("try another func name");var expression="\\.sig\\|\\|([a-zA-Z0-9$]+)\\(";var pattern=new RegExp(expression,"i");var founds=pattern.exec(jsplayer);if(founds&&founds.length>0){functionName=founds[1]}}if(functionName){AMUtility.debugLog("funcname: "+functionName);var intr=new AMYoutubeJsPlayerInterpreter(jsplayer);AMUtility.debugLog("intr: "+intr);var func=intr.extract_function(intr,functionName);AMUtility.debugLog("func: "+func);return func}}return null};YoutubeProbe.prototype.getDecodeFunc=function(playerUrl){var decodeFunc=null;AMUtility.debugLog("getDecodeFunc");if(playerUrl){AM_GLOBAL_OBJECT.decodeSig=null;var jsplayer=AMUtility.httpGet(playerUrl);AMUtility.debugLog("jsplayer got");var functionName=AMTextMatchTools.findMatch(jsplayer,/signature=([a-zA-Z]+)\(+/);
AMUtility.debugLog("try old func name: "+functionName);if(!functionName){var expression="\\.sig\\|\\|([a-zA-Z0-9$]+)\\(";var pattern=new RegExp(expression,"i");var founds=pattern.exec(jsplayer);if(founds&&founds.length>0){functionName=founds[1]}AMUtility.debugLog("try another func name: "+functionName)}if(functionName){var decodeFuncAssignment="AM_GLOBAL_OBJECT.decodeSig="+functionName+";";var newpage=AMTextMatchTools.insert(jsplayer,jsplayer.length-6,decodeFuncAssignment);AMUtility.debugLog("prepare new page length: "+newpage.length);var t1=new Date;try{eval(newpage)}catch(e){AMUtility.debugLog("unable to evaluate player")}AMUtility.logIntervalInSeconds("evaluate",t1);if(AM_GLOBAL_OBJECT.decodeSig){decodeFunc=AM_GLOBAL_OBJECT.decodeSig;AMUtility.debugLog("assign decode func: "+decodeFunc)}}else{AMUtility.debugLog("unable to find decode function.")}}return decodeFunc};YoutubeProbe.prototype.getPlaylistLength=function(playlistRoot){var length=null;if(playlistRoot&&playlistRoot.content&&playlistRoot.content.playlist_header&&playlistRoot.content.playlist_header.num_videos_text&&playlistRoot.content.playlist_header.num_videos_text.runs&&playlistRoot.content.playlist_header.num_videos_text.runs.length>0){var lengthStr=playlistRoot.content.playlist_header.num_videos_text.runs[0].text;if(lengthStr&&lengthStr.length>0){var founds=lengthStr.match(/(\d+)/);if(founds&&founds.length>1){length=founds[1]}}}else{AMUtility.debugLog("cannot find playlist length")}return length};YoutubeProbe.prototype.getPlaylistTitle=function(playlistRoot){var title="";if(playlistRoot&&playlistRoot.content&&playlistRoot.content.playlist_header&&playlistRoot.content.playlist_header.title&&playlistRoot.content.playlist_header.title.runs&&playlistRoot.content.playlist_header.title.runs.length>0){title=playlistRoot.content.playlist_header.title.runs[0].text}else{AMUtility.debugLog("cannot find playlist title")}return title};YoutubeProbe.prototype.getPlaylistVideos=function(playlistRoot){var playlistVideos=[];var node=null;if(playlistRoot){node=playlistRoot.content&&playlistRoot.content.section_list?playlistRoot.content.section_list:null;if(!node){node=playlistRoot.content&&playlistRoot.content.continuation_contents?playlistRoot.content.continuation_contents:null}while(node){if(node.contents&&node.contents.length>0){if(node.contents[0].item_type!=="playlist_video"){node=node.contents[0]}else{break}}else{node=null}}}if(node&&node.contents){var youtubePlaylistVideos=node.contents;playlistVideos=this.extractPlaylistVideos(youtubePlaylistVideos)}return playlistVideos};YoutubeProbe.prototype.extractPlaylistVideos=function(youtubePlaylistVideos){var playlistVideos=[];if(youtubePlaylistVideos&&youtubePlaylistVideos.length>0){for(var i=0;i<youtubePlaylistVideos.length;i++){var playlistVideo=this.extractPlaylistVideo(youtubePlaylistVideos[i]);if(playlistVideo){playlistVideos.push(playlistVideo)}}}return playlistVideos};YoutubeProbe.prototype.extractPlaylistVideo=function(youtubePlaylistVideo){var playlistVideo=null;if(youtubePlaylistVideo){playlistVideo={};playlistVideo.image=youtubePlaylistVideo.thumbnail&&youtubePlaylistVideo.thumbnail.url?"http:"+youtubePlaylistVideo.thumbnail.url:"";playlistVideo.title=youtubePlaylistVideo.title&&youtubePlaylistVideo.title.runs&&youtubePlaylistVideo.title.runs[0]&&youtubePlaylistVideo.title.runs[0].text?youtubePlaylistVideo.title.runs[0].text:"";playlistVideo.url=youtubePlaylistVideo.video_id?"http://www.youtube.com/watch?v="+youtubePlaylistVideo.video_id:""}return playlistVideo};YoutubeProbe.prototype.getContinuationUrl=function(playlistRoot){var url=null;var node=playlistRoot&&playlistRoot.content&&playlistRoot.content.section_list?playlistRoot.content.section_list:null;if(!node){node=playlistRoot.content&&playlistRoot.content.continuation_contents?playlistRoot.content.continuation_contents:null}while(node){if(node.contents&&node.contents.length>0){if(node.item_type&&node.item_type==="playlist_video_list"&&node.playlist_id&&node.continuations&&node.continuations.length>0){var playlistId=node["playlist_id"];var continuation=node.continuations[0];if(continuation){var click_tracking_params=continuation["click_tracking_params"]?encodeURIComponent(continuation["click_tracking_params"]):null;var continuation=continuation["continuation"]?encodeURIComponent(continuation["continuation"]):null;if(click_tracking_params&&continuation&&playlistId){AMUtility.debugLog("list: "+playlistId);AMUtility.debugLog("ctoken: "+continuation);AMUtility.debugLog("itct: "+click_tracking_params);url="http://m.youtube.com/playlist?action_continuation=1&ajax=1&ctoken="+continuation+"&itct="+click_tracking_params+"&layout=mobile&list="+playlistId+"&tsp=1&utcoffset=480"}}break}else{AMUtility.debugLog("try sub contents");node=node.contents[0]}}else{AMUtility.debugLog("Find video end");break}}return url};YoutubeProbe.prototype.getPlaylist=function(playlistId,httpProtocol){httpProtocol=httpProtocol?httpProtocol:"http";var root=this.getPlaylistRoot(playlistId,httpProtocol);var playlist=this.getPlaylistFull(root);return this.decoratePlaylistInCallbackFormat(playlist)};YoutubeProbe.prototype.decoratePlaylistInCallbackFormat=function(playlist){var callbackItem=null;if(playlist.playlist&&playlist.playlist.length>0){callbackItem={};callbackItem["status"]=true;callbackItem["update"]=(new Date).format("yyyy-mm-dd HH:MM:ss");callbackItem["current_page"]=1;callbackItem["next_page"]=1;callbackItem["repeat_all"]=true;callbackItem["total_item"]=playlist.playlist.length;callbackItem["channel_name"]=playlist["title"]?playlist["title"]:"";callbackItem["playlist"]=playlist.playlist}return callbackItem};YoutubeProbe.prototype.getPlaylistRoot=function(playlistId,httpProtocol){var root=null;if(playlistId){var info_url=httpProtocol+"://m.youtube.com/playlist?ajax=1&layout=mobile&list="+playlistId+"&tsp=1&utcoffset=480";AMUtility.debugLog("Search video root for playlist: ["+playlistId+"] at url: "+info_url+" location.href: "+location.href);var webpage=AMUtility.xmlHttpGet(info_url);AMUtility.debugLog("webpage:\n"+webpage);root=JSON.parse(webpage.replace(")]}'",""));AMUtility.debugLog("got root? "+root)}return root};YoutubeProbe.prototype.getPlaylistFull=function(playlistRoot){AMUtility.debugLog("Extracting playlist...");var playlistFull={};playlistFull.playlist=[];if(playlistRoot){playlistFull.title=this.getPlaylistTitle(playlistRoot)?this.getPlaylistTitle(playlistRoot):"";AMUtility.debugLog("title: "+playlistFull.title);playlistFull.playlist=this.getPlaylistVideos(playlistRoot);var continuationUrl=null;var continuationNode=playlistRoot;do{continuationUrl=this.getContinuationUrl(continuationNode);if(continuationUrl){var continueWebpage=AMUtility.httpGet(continuationUrl);continuationNode=JSON.parse(continueWebpage.replace(")]}'",""));var continuationList=this.getPlaylistVideos(continuationNode);if(continuationList&&continuationList.length>0){AMUtility.debugLog("Found video list with length:"+continuationList.length);playlistFull.playlist=playlistFull.playlist.concat(continuationList)}}}while(continuationUrl)}AMUtility.debugLog("[PLAYLIST] - "+playlistFull.title);for(var i in playlistFull.playlist){AMUtility.debugLog("["+i+"] "+"video title: "+playlistFull.playlist[i].title+" url: "+playlistFull.playlist[i].url+" image: "+playlistFull.playlist[i].image)}return playlistFull};function ClassHandler(constructor,args){this.constructor=constructor;this.args=args}function ProbeManager(){AMUtility.debugLog("Init ProbeManager");this.handlers=[];if("undefined"!==typeof YoutubeProbe)this.handlers.push(new ClassHandler(YoutubeProbe,YoutubeProbe.INTERPRETER_DECODE));if("undefined"!==typeof VimeoProbe)this.handlers.push(new ClassHandler(VimeoProbe,null));if("undefined"!==typeof DailyMotionProbe)this.handlers.push(new ClassHandler(DailyMotionProbe,null));if("undefined"!==typeof TwitchProbe)this.handlers.push(new ClassHandler(TwitchProbe,null))}ProbeManager.prototype.getSrc=function(url){AMUtility.debugLog("try getSrc: "+url);var src=null;for(var i in this.handlers){try{var handler=this.handlers[i];if(handler.constructor.can(url)){var probeConstructor=handler.constructor.bind(null,url);var probe=new probeConstructor(handler.args);AMUtility.debugLog("Found probe: ["+probe.getName()+"]");src=probe.getMediaSource();if(src){break}}}catch(err){AMUtility.debugLog("found probe error: "+err)}}return src};function AMUtility(){}AMUtility.debugLog=function(msg){print(msg)};AMUtility.httpGet=function(url){AMUtility.debugLog("AMUtility.httpGet url: "+url);return httpGetContent(url)};function getVideoSrc(url){AMUtility.debugLog("Get media for url: "+url);var manager=new ProbeManager;return manager.getSrc(url)}